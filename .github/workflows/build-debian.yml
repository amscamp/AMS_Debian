name: build-debian

on:
  push:
    branches:
      - main
      - dev
    paths:
      - '**'
      - '!README.md'
      - '!LICENSE'
      - '!preseed.cfg'
      - '!.github/workflows/versioncheck.yml'
  pull_request:
    branches: 
      - main
      - dev
    paths:
      - '**'
      - '!README.md'
      - '!LICENSE'
      - '!preseed.cfg'
      - '!.github/workflows/versioncheck.yml'

  repository_dispatch:
    types: [new-version]

  workflow_dispatch: # Allows action to be run manually from the Actions tab

jobs:
  build-debian:
    runs-on: ubuntu-latest

    steps:
      - name: set ref name on push/pull
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
        run: echo "DEBIANREFNAME=${{github.ref_name}}" >> $GITHUB_ENV
      - name: set ref name on repository_dispatch
        if: ${{ github.event_name == 'repository_dispatch' }}
        run: echo "DEBIANREFNAME=${{ github.event.client_payload.ref_name }}" >> $GITHUB_ENV
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
          ref: ${{ env.DEBIANREFNAME	}}
      - name: Build Linux Image
        run: ./create_iso.sh      
      - name: List Foldercontent
        run: ls -la
      - name: rename image
        run: mv debian-*-amd64-modified.iso debian-$(ls debian-*-modified* |  perl -pe '($_)=/([0-9]+([.][0-9]+)+)/')-amd64-ams-${{ env.DEBIANREFNAME	}}.iso
      - name: get release version
        run: echo "DEBIANVERSION=$(ls debian-*-amd64-ams* |  perl -pe '($_)=/([0-9]+([.][0-9]+)+)/')-${{ env.DEBIANREFNAME	}}" >> $GITHUB_ENV
      - name: echo release version
        run: echo ${{ env.DEBIANVERSION }}
      - name: check if tag already exists
        uses: rickstaa/action-create-tag@v1
        continue-on-error: true
        id: tag_create_first
        with:
          tag: ${{ env.DEBIANVERSION }}
          tag_exists_error: true
          message: "${{ env.DEBIANVERSION }} release"
      - name: delete tag if nessecary
        uses: dev-drprasad/delete-tag-and-release@v1.0 # PRERELEASE is v1.0 and can also be used to test and give us feedback
        if: ${{ steps.tag_create_first.outputs.tag_exists || steps.tag_create_first.outcome != 'success' }}
        with:
          tag_name: ${{ env.DEBIANVERSION }} #(required) tag name to delete 
          github_token: ${{ secrets.GITHUB_TOKEN }} # (required) a GitHub token with write access to the repo that needs to be modified
          delete_release: true #(optional) default: true 
      - name: (re)create tag
        uses: rickstaa/action-create-tag@v1
        id: tag_create_second
        with:
          tag: ${{ env.DEBIANVERSION }}
          force_push_tag: true
          message: "${{ env.DEBIANVERSION }} release"
      - name: Release
        uses: softprops/action-gh-release@v1
        if: ${{ startsWith(env.DEBIANREFNAME, 'main')	}}
        with:
          files: "${{ github.workspace }}/debian-*-amd64-ams-${{ env.DEBIANREFNAME }}.iso"
          tag_name: ${{ env.DEBIANVERSION }}
          body: current debian ${{ env.DEBIANVERSION }}
          name: Release ${{ env.DEBIANVERSION }}
          target_commitish: main
          prerelease: false
      - name: Prerelease
        uses: softprops/action-gh-release@v1
        if: ${{ startsWith(env.DEBIANREFNAME, 'dev')	}}
        with:
          files: "${{ github.workspace }}/debian-*-amd64-ams-${{ env.DEBIANREFNAME }}.iso"
          tag_name: ${{ env.DEBIANVERSION }}
          body: current debian ${{ env.DEBIANVERSION }}
          name: Release ${{ env.DEBIANVERSION }}
          target_commitish: dev
          prerelease: true